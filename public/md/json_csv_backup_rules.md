# 📘 JSON ↔ CSV 백업 · 복구 규칙서

---

## 1. 목적

- 애플리케이션 내부 데이터는 JSON 구조를 유지한다.
- 백업 시에는 CSV로 변환하여 다운로드 또는 외부 저장을 수행한다.
- 복구 시에는 CSV를 다시 JSON으로 되돌려 원형 구조를 회복한다.
- 이 과정에서 데이터 손실·스키마 파손·타입 오류를 최소화하는 것을 최우선으로 한다.

---

## 2. JSON 구조에 대한 기본 원칙

1. JSON 데이터는 명확한 스키마를 가진다.
2. 모든 객체의 필드는 대소문자·형식·네이밍을 고정한다.
3. 구조 변경(필드 추가/삭제/타입 변경)이 발생하면 버전을 증가시킨다.
4. 필드는 가능하면 null 대신 명시적 값을 사용한다. (예: 빈 문자열, 숫자 0 등)

---

## 3. CSV 변환 시 평탄화(Flatten) 규칙

JSON은 트리 구조이므로 CSV는 평탄화가 필수다.  
다음 규칙을 모든 데이터에 일관되게 적용한다.

### 📌 3.1 중첩 객체

- 하위 키는 **"부모키.자식키"** 형태로 연결한다.

**예:**
```
user.name → user.name
user.contact.email → user.contact.email
```

### 📌 3.2 배열

배열은 인덱스를 붙여 필드화하거나 JSON 원본 문자열로 묶는다.

#### 직접 평탄화 방식:
```
items[0].name → items.0.name
items[1].price → items.1.price
```

#### 문자열 보관 방식:
배열 전체를 하나의 문자열로 유지
```
items → ["book","pen","cup"]
```
※ 복구 시 `JSON.parse` 과정을 거친다.

### 📌 3.3 Null 표현

CSV는 null과 빈 문자열을 구분하지 못한다.  
따라서 전용 토큰을 사용한다.

- `null` → `__NULL__`
- `undefined` → `__UNDEF__`

---

## 4. CSV를 JSON으로 복구하는 규칙

CSV는 "평탄화된 상태"이므로 반드시 역평탄화 규칙을 적용한다.

### 📌 4.1 필드 역재구성

- `"parent.child"` → `{ parent: { child: value } }`
- `"list.0.name"` → `{ list: [{ name: value }] }`

### 📌 4.2 데이터 타입 복원

CSV의 모든 값은 문자열로 저장되므로 타입을 반드시 되돌린다.

- **숫자**: `"10"` → `10`
- **불리언**: `"true"` → `true`
- **날짜**: `"2025-01-09"` → Date 객체 또는 ISO 문자열
- **null 토큰**: `"__NULL__"` → `null`

변환 규칙은 코드가 아니라 문서에 기록되어야 한다.  
그래야 팀·미래의 자신이 동일하게 복구한다.

---

## 5. 스키마 버전 규칙

데이터 구조는 시간이 지나며 변한다. 이를 기록해 과거 백업 호환성을 보장한다.

### 📌 5.1 CSV 첫 줄 또는 별도 메타

- CSV 맨 위 헤더 또는 별도 파일에 `schemaVersion`을 포함한다.
- 구조 변경 시 버전을 증가시킨다. (예: 1 → 2 → 3)

### 📌 5.2 복구 시 동작

- 현재 앱의 스키마 버전과 비교한다.
- 버전이 낮으면 마이그레이션 단계를 거친다.
- 버전이 높으면 복구를 중단하고 관리자 확인을 요구한다.

---

## 6. 필드 누락 / 추가 처리

- CSV에 존재하지 않는 필드는 기본값으로 채운다.
- CSV에 존재하지만 스키마에 없는 필드는 무시하거나 보관 영역에 저장한다.
- 사용자 입력 오류는 복구 전에 validation 단계에서 모두 걸러낸다.

---

## 7. 일관성 검사(Validation)

복구 단계 전에 반드시 다음을 체크한다.

1. `schemaVersion` 존재 여부
2. 필수 필드 존재 여부
3. 허용되지 않은 타입/토큰 여부
4. 배열 인덱스 연속성 (0,1,2…)
5. null/빈값 구분 정확성

검증 실패 시 복구를 중단하고 오류 보고한다.

---

## 8. 예외 상황 원칙

- 변환 규칙이 모호하면 JSON 원본을 문자열로 저장하는 방식을 우선한다.
- 백업 CSV는 무조건 불변 원본으로 취급하고 가공하지 않는다.
- CSV가 읽히지 않을 경우, JSON 백업을 2차 보호 데이터로 추가 보관한다.

---

## 요약

| 항목 | 규칙 |
|------|------|
| **내부 저장** | JSON 구조 유지 |
| **백업 형식** | CSV (평탄화) |
| **복구 형식** | JSON (역평탄화) |
| **null 표현** | `__NULL__` / `__UNDEF__` |
| **배열 처리** | 인덱스 평탄화 or JSON 문자열 |
| **버전 관리** | `schemaVersion` 필수 |
| **검증** | 복구 전 필수 validation |

---

*본 규칙서는 데이터 무결성과 호환성을 보장하기 위한 필수 문서입니다.*